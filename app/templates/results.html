{% extends "base.html" %}
{% block content %}
<div class="row space-between">
  <div>
    <h1>Analysis Results</h1>
    <div class="muted">Document: {{ result.document }}</div>
  </div>
  <a class="btn" href="/report/{{ analysis_id }}/pdf">‚¨áÔ∏è Export PDF Report</a>
</div>

<div class="cards-row">
  <div class="card metric">
    <div class="metric-big">{{ result.score }}%</div>
    <div class="muted">Compliance Score</div>
  </div>
  <div class="card metric border-red">
    <div class="metric-big">{{ result.counts.high }}</div>
    <div class="muted">High Priority</div>
  </div>
  <div class="card metric border-orange">
    <div class="metric-big">{{ result.counts.medium }}</div>
    <div class="muted">Medium Priority</div>
  </div>
  <div class="card metric border-green">
    <div class="metric-big">{{ result.counts.low }}</div>
    <div class="muted">Low Priority</div>
  </div>
</div>

<div class="grid-2">
  <div class="card">
    <h3>Compliance Overview</h3>
    <canvas id="donut"></canvas>
  </div>
  <div class="card">
    <h3>Issues by Category</h3>
    <canvas id="bars"></canvas>
  </div>
</div>

<div class="card">
  <h3>Detailed Findings <small class="muted">({{ result.findings|length }} issues found)</small></h3>
  
  <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
    <button class="btn-outline btn-small filter-btn active" data-filter="all">All ({{ result.findings|length }})</button>
    <button class="btn-outline btn-small filter-btn" data-filter="high">High ({{ result.counts.high }})</button>
    <button class="btn-outline btn-small filter-btn" data-filter="medium">Medium ({{ result.counts.medium }})</button>
    <button class="btn-outline btn-small filter-btn" data-filter="low">Low ({{ result.counts.low }})</button>
  </div>
  
  <div class="findings" id="findingsContainer">
    {% for f in result.findings %}
    <div class="finding {{ f.severity }}" id="{{ f.element_id }}" data-severity="{{ f.severity }}">
      <div class="finding-top">
        <div class="chips">
          <span class="chip">
            <!-- FIXED: Echte <a> tag -->
            <a href="{{ f.hyperlink }}" class="issue-link" data-hash="{{ f.hyperlink }}">
              üìé {{ f.location }}
            </a>
          </span>
          <span class="chip">{{ f.category }}</span>
          <span class="chip severity-{{ f.severity }}">{{ f.severity|upper }}</span>
        </div>
        <div>
          <small class="muted">Page: {{ f.page }}</small>
        </div>
      </div>
      <div class="finding-title">{{ f.message }}</div>
      {% if f.detail %}
      <div class="muted small">{{ f.detail }}</div>
      {% endif %}
      <div style="margin-top: 10px; font-size: 12px;">
        <!-- FIXED: Echte <a> tag -->
        <a href="{{ f.hyperlink }}" class="jump-link" data-hash="{{ f.hyperlink }}">
          üîó Jump to this issue
        </a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- DEBUG PANEL -->
<div id="debugPanel" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; display: none;">
  <h4>Debug Info</h4>
  <div id="debugContent"></div>
</div>

<style>
.issue-link, .jump-link {
  color: var(--blue);
  text-decoration: none;
  cursor: pointer;
}

.issue-link:hover, .jump-link:hover {
  text-decoration: underline;
  color: #0d2bb4;
}

.finding.highlighted {
  animation: highlight-pulse 2s ease-in-out;
  border-left: 4px solid var(--blue) !important;
}

@keyframes highlight-pulse {
  0% { box-shadow: 0 0 0 0 rgba(26, 60, 224, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(26, 60, 224, 0); }
  100% { box-shadow: 0 0 0 0 rgba(26, 60, 224, 0); }
}

.filter-btn {
  padding: 6px 12px;
  font-size: 12px;
  border-radius: 8px;
  cursor: pointer;
  border: 1px solid var(--border);
  background: white;
}
.filter-btn.active {
  background: var(--blue);
  color: white;
  border-color: var(--blue);
}
.chip.severity-high {
  background: rgba(239, 68, 68, 0.1);
  color: var(--red);
  border: 1px solid rgba(239, 68, 68, 0.3);
}
.chip.severity-medium {
  background: rgba(245, 158, 11, 0.1);
  color: var(--orange);
  border: 1px solid rgba(245, 158, 11, 0.3);
}
.chip.severity-low {
  background: rgba(34, 197, 94, 0.1);
  color: var(--green);
  border: 1px solid rgba(34, 197, 94, 0.3);
}
.btn-small {
  padding: 4px 8px;
  font-size: 12px;
}
</style>

<script>
// ===== HYPERLINK SYSTEM =====
function scrollToHash(hash) {
  console.log('scrollToHash called:', hash);
  
  if (!hash || !hash.startsWith('#')) {
    console.error('Invalid hash:', hash);
    return false;
  }
  
  const elementId = hash.substring(1);
  console.log('Looking for element ID:', elementId);
  
  const targetElement = document.getElementById(elementId);
  
  if (targetElement) {
    console.log('‚úì Element found, scrolling...');
    
    // Scroll to element
    targetElement.scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });
    
    // Add highlight class
    targetElement.classList.add('highlighted');
    
    // Remove highlight after 3 seconds
    setTimeout(() => {
      targetElement.classList.remove('highlighted');
    }, 3000);
    
    // Update URL
    window.history.pushState(null, null, hash);
    
    return true;
  } else {
    console.error('‚úó Element not found:', elementId);
    
    // Show available IDs for debugging
    const allIds = Array.from(document.querySelectorAll('[id]')).map(el => el.id);
    console.log('Available IDs:', allIds.filter(id => id.startsWith('issue-')));
    
    return false;
  }
}

// ===== CLICK HANDLER =====
document.addEventListener('click', function(event) {
  // Check if clicked on issue link
  if (event.target.matches('.issue-link, .jump-link') || 
      event.target.closest('.issue-link, .jump-link')) {
    
    event.preventDefault();
    
    const link = event.target.matches('.issue-link, .jump-link') 
      ? event.target 
      : event.target.closest('.issue-link, .jump-link');
    
    const hash = link.getAttribute('href');
    console.log('Link clicked:', hash);
    
    const success = scrollToHash(hash);
    
    if (!success) {
      alert('Could not find the issue. Please try another issue.');
    }
  }
  
  // Filter button handler
  if (event.target.matches('.filter-btn')) {
    const filter = event.target.getAttribute('data-filter');
    
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Filter findings
    const findings = document.querySelectorAll('.finding');
    findings.forEach(finding => {
      const severity = finding.getAttribute('data-severity');
      if (filter === 'all' || severity === filter) {
        finding.style.display = 'block';
      } else {
        finding.style.display = 'none';
      }
    });
    
    console.log(`Filter applied: ${filter}`);
  }
});

// ===== PAGE LOAD =====
document.addEventListener('DOMContentLoaded', function() {
  console.log('=== LAM√âCO HYPERLINK SYSTEM LOADED ===');
  
  // Check initial state
  const links = document.querySelectorAll('.issue-link, .jump-link');
  console.log(`Found ${links.length} hyperlinks`);
  
  const findings = document.querySelectorAll('.finding');
  console.log(`Found ${findings.length} findings`);
  
  // Log all issue IDs
  findings.forEach((finding, index) => {
    console.log(`Finding ${index + 1}: ID="${finding.id}"`);
  });
  
  // Handle URL hash on page load
  if (window.location.hash) {
    console.log('Initial hash detected:', window.location.hash);
    
    setTimeout(() => {
      const success = scrollToHash(window.location.hash);
      if (!success) {
        console.log('Could not scroll to initial hash');
      }
    }, 1000);
  }
  
  // Enable debug panel (Ctrl+D)
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'd') {
      e.preventDefault();
      const debugPanel = document.getElementById('debugPanel');
      debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
      
      if (debugPanel.style.display === 'block') {
        const debugContent = document.getElementById('debugContent');
        debugContent.innerHTML = `
          <strong>Debug Information:</strong><br>
          Total findings: ${findings.length}<br>
          Total links: ${links.length}<br>
          Current hash: ${window.location.hash || 'none'}<br>
          <br>
          <strong>First 5 issue IDs:</strong><br>
          ${Array.from(findings).slice(0, 5).map(f => f.id).join('<br>')}
        `;
      }
    }
  });
});

// ===== CHARTS =====
const score = {{ result.score }};
const categories = {{ result.category_counts | tojson }};
const labels = Object.keys(categories);
const highs = labels.map(l => categories[l].high);
const meds = labels.map(l => categories[l].medium);
const lows = labels.map(l => categories[l].low);

// Donut chart
if (document.getElementById('donut')) {
  try {
    new Chart(document.getElementById('donut'), {
      type: 'doughnut',
      data: {
        labels: ['Compliant', 'Issues'],
        datasets: [{
          data: [score, 100 - score],
          backgroundColor: ['#22c55e', '#ef4444']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
    console.log('‚úì Donut chart loaded');
  } catch (e) {
    console.error('‚úó Donut chart error:', e);
  }
}

// Bar chart
if (document.getElementById('bars')) {
  try {
    new Chart(document.getElementById('bars'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: 'High', data: highs, backgroundColor: '#ef4444' },
          { label: 'Medium', data: meds, backgroundColor: '#f59e0b' },
          { label: 'Low', data: lows, backgroundColor: '#22c55e' }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { stacked: true },
          y: { beginAtZero: true, stacked: true }
        }
      }
    });
    console.log('‚úì Bar chart loaded');
  } catch (e) {
    console.error('‚úó Bar chart error:', e);
  }
}

console.log('=== INITIALIZATION COMPLETE ===');
</script>
{% endblock %}